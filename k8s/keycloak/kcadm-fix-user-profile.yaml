apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-fix-user-profile
  namespace: keycloak
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kcadm
          image: quay.io/keycloak/keycloak:24.0.5
          envFrom:
            - secretRef:
                name: keycloak-admin
          command: ["/bin/bash","-c"]
          args:
            - |
              set -e
              until /opt/keycloak/bin/kcadm.sh config credentials --server http://keycloak.keycloak.svc.cluster.local \
                --realm master --user ${KEYCLOAK_ADMIN} --password ${KEYCLOAK_ADMIN_PASSWORD}; do sleep 3; done
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r lab -q username=tester --fields id | sed -n 's/.*\"id\" *: *\"\([^\"]*\)\".*/\1/p' | head -n1)
              test -n "$USER_ID" || { echo "no tester"; exit 1; }
              /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r lab \
                -s firstName=Test -s lastName=User -s email=tester@example.com -s emailVerified=true -s enabled=true -s requiredActions=[]
              /opt/keycloak/bin/kcadm.sh set-password -r lab --userid $USER_ID --new-password tester123 --temporary=false
              echo done
